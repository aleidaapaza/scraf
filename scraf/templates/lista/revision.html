{% extends 'base/baseListasyRegistroModal.html' %}
{% load static %}
{% block modalExtra %}
<!-- Modal -->
<div class="modal fade" id="modalAdvertenciaRevision" tabindex="-1" aria-labelledby="modalAdvertenciaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title text-dark" id="modalAdvertenciaLabel">Advertencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-dark">
        Ya hay una revisión activa en proceso. No puedes iniciar otra hasta que finalice la actual.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de resultado Inicio/Fin -->
<div class="modal fade" id="modalStatusRevision" tabindex="-1" aria-labelledby="modalStatusLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div id="statusHeader" class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalStatusLabel">Estado de la revisión</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="statusBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock  %}
{% block thead %}
    <tr>
        {% if user.is_encargado or user.is_superuser %}
        <th scope="col">LINE</th>
        {% endif %}
        <th scope="col">CODIGO</th>
        <th scope="col">DESCRIPCION DE LA REVISION</th>
        <th scope="col">ENCARGADO</th>
        <th scope="col">VER/EDITAR</th>
        <th scope="col">FECHA DE INICIO</th>
        <th scope="col">FECHA DE FINALIZACION</th>
        {% if user.is_encargado %}
        <th scope="col">ESTADO</th>
        <th scope="col">INICIO/FIN</th>
        {% endif %}
        <th scope="col">LISTA COMPLETA</th>
        {% if revisionr %}
        <th scope="col">FORMULARIO DE REVISION</th>    
        {% endif %}        
    </tr>

{% endblock %}
{% block tbody %}
    {% for revision in object_list %}
        <tr>
            {% if user.is_encargado or user.is_superuser %}
            <td><a href="{% url 'revision:lista_revisiones_line' revision.slug %}"><i class="fas fa-eye"></i></a></td>
            {% endif %}
            <td> {{ revision.slug }}</td>
            <td> {{ revision.nombre }} </td>
            <td> {{ revision.encargado.persona.nombrecompleto }}</td>
            <td>
                {% if revision.estado == None %}
                <button 
                    class="btn btn-primary btn-editar" 
                    data-url="{% url 'revision:ajax_a_Revision' revision.slug %}">
                    <i class="fas fa-edit"></i>
                </button>
                {% else %}
                <button
                    class="btn btn-primary btn-ver" 
                    data-url="{% url 'revision:ajax_ver_Revision' revision.slug %}">
                    <i class="fas fa-eye"></i>
                </button>
                {% endif %}
            </td>
            <td id="fecha-inicio-{{ revision.slug }}"> {{ revision.fechaHora_inicio }}</td>
            <td id="fecha-fin-{{ revision.slug }}"> {{ revision.fechaHora_finalizacion }}</td>            
            <td id="estado-{{ revision.slug }}"> {% if revision.estado == None %} Sin Accion
            {% elif revision.estado %} En Curso {% else %} Finalizado
            {% endif %}</td>
            <td>
                {% if revisionr and revision_datos.slug != revision.slug %}
                    <button type="button"
                            class="btn btn-primary-subtle btn-xs iniciar-finalizar-true"
                            data-revisionr="true">
                        {% if revision.estado == None %}<i class="fas fa-circle text-danger"></i>
                        {% elif revision.estado %}<i class="fas fa-play-circle text-primary"></i>
                        {% else %}<i class="fas fa-check-circle text-success"></i>{% endif %}
                    </button>
                    {% else %}
                    <button type="button"
                            class="btn btn-primary-subtle btn-xs iniciar-finalizar-revision"
                            data-url="{% url 'revision:inicio_fin_revision' revision.slug %}"
                            data-slug="{{ revision.slug }}">
                        {% if revision.estado == None %}<i class="fas fa-circle text-danger"></i>
                        {% elif revision.estado %}<i class="fas fa-play-circle text-primary"></i>
                        {% else %}<i class="fas fa-check-circle text-success"></i>{% endif %}
                    </button>
                {% endif %}
            </td>
            <td>
                <a href="" type="button"
                   class="btn btn-primary btn-xs">
                   <i class="fas fa-edit"></i> 
                </a>
            </td>
            {% if revision_datos %}
                <td>
                {% if revision.slug == revision_datos.slug %}                
                    <a href="{% url 'revision:revision_activo' revision.slug %}" type="button"
                    class="btn btn-primary btn-xs">
                    <i class="fas fa-edit"></i> 
                    </a>
                {% else %}
                <p>-</p>
                {% endif %}
                </td>
            {% endif %}            
        </tr>
    {% endfor %}
{% endblock %}

{% block scripfun %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // REGISTRAR NUEVA REVISION
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#id_btn1');
    if (!btn) return;
    e.preventDefault();
    const url = btn.dataset.url || "{{ entity_registro|default:'' }}";
    if (!url) return console.error('Falta data-url en #id_btn1');
    if (typeof cargarFormularioModal === 'function') {
      cargarFormularioModal(url);
    }
  });

  // VER (usa modal2)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-ver');
    if (!btn) return;
    e.preventDefault();
    const url = btn.getAttribute('data-url');
    fetch(url)
      .then(r => r.json())
      .then(data => {
        document.getElementById('modalContent2').innerHTML = data.html_form;
        new bootstrap.Modal(document.getElementById('modal2')).show();
      })
      .catch(err => console.error(err));
  });

  // EDITAR (usa modal2 con POST)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-editar');
    if (!btn) return;
    e.preventDefault();
    const url = btn.dataset.url;
    if (typeof actualizarFormularioModal === 'function') {
      actualizarFormularioModal(url);
    } else {
      // Fallback (rara vez necesario)
      fetch(url)
        .then(r => r.json())
        .then(data => {
          const modalEl = document.getElementById('modal2');
          document.getElementById('modalContent2').innerHTML = data.html_form;
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
          const form = modalEl.querySelector('form');
          form.addEventListener('submit', function (ev) {
            ev.preventDefault();
            const formData = new FormData(form);
            fetch(url, { method: 'POST', body: formData })
              .then(r => r.json())
              .then(resp => {
                if (resp.form_is_valid) { modal.hide(); location.reload(); }
                else { document.getElementById('modalContent2').innerHTML = resp.html_form; }
              })
              .catch(err => console.error(err));
          });
        })
        .catch(err => console.error(err));
    }
  });

  // ADVERTENCIA si hay otra revisión activa
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.iniciar-finalizar-true');
    if (!btn) return;
    e.preventDefault();
    new bootstrap.Modal(document.getElementById('modalAdvertenciaRevision')).show();
  });
});
</script>

{% endblock %}

{% block funScript %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table = document.getElementById('myTable') || document;

  table.addEventListener('click', function (e) {
    const btn = e.target.closest('.iniciar-finalizar-revision');
    if (!btn) return;

    e.preventDefault();
    const url  = btn.getAttribute('data-url');
    const slug = btn.getAttribute('data-slug');

    fetch(url)
      .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t); }))
      .then(data3 => {
        // Construir modal
        let titulo = 'Estado de la revisión';
        let headerClass = 'bg-primary text-white';
        let contenido = '';

        if (data3.status === 'iniciada') {
          titulo = 'Revisión iniciada';
          headerClass = 'bg-success text-white';
          contenido = `
            <p class="mb-1"><strong>Estado:</strong> En Curso</p>
            ${data3.fechaHora_inicio ? `<p class="mb-0"><strong>Fecha/Hora de inicio:</strong> ${data3.fechaHora_inicio}</p>` : ''}
          `;
        } else if (data3.status === 'finalizada') {
          titulo = 'Revisión finalizada';
          headerClass = 'bg-success text-white';
          contenido = `
            <p class="mb-1"><strong>Estado:</strong> Finalizado</p>
            ${data3.fechaHora_finalizacion ? `<p class="mb-0"><strong>Fecha/Hora de finalización:</strong> ${data3.fechaHora_finalizacion}</p>` : ''}
          `;
        } else if (data3.status === 'ya_finalizada') {
          titulo = 'Revisión ya finalizada';
          headerClass = 'bg-info text-white';
          contenido = `<p class="mb-0">Esta revisión ya estaba finalizada.</p>`;
        } else {
          headerClass = 'bg-secondary text-white';
          contenido = `<p class="mb-0">Estado: ${data3.status ?? 'Desconocido'}</p>`;
        }

        // Pintar modal
        const header = document.getElementById('statusHeader');
        header.className = 'modal-header ' + headerClass;
        document.getElementById('modalStatusLabel').textContent = titulo;
        document.getElementById('statusBody').innerHTML = contenido;
        new bootstrap.Modal(document.getElementById('modalStatusRevision')).show();

        // Actualizar fila sin recargar
        const estadoCell = document.getElementById(`estado-${slug}`);
        const inicioCell = document.getElementById(`fecha-inicio-${slug}`);
        const finCell    = document.getElementById(`fecha-fin-${slug}`);

        if (data3.status === 'iniciada') {
          if (estadoCell) estadoCell.textContent = 'En Curso';
          if (inicioCell && data3.fechaHora_inicio) inicioCell.textContent = data3.fechaHora_inicio;
          const icon = btn.querySelector('i'); if (icon) icon.className = 'fas fa-play-circle text-primary';
        }
        if (data3.status === 'finalizada') {
          if (estadoCell) estadoCell.textContent = 'Finalizado';
          if (finCell && data3.fechaHora_finalizacion) finCell.textContent = data3.fechaHora_finalizacion;
          const icon = btn.querySelector('i'); if (icon) icon.className = 'fas fa-check-circle text-success';
        }
      })
      .catch(err => {
        const header = document.getElementById('statusHeader');
        header.className = 'modal-header bg-danger text-white';
        document.getElementById('modalStatusLabel').textContent = 'Error';
        document.getElementById('statusBody').innerHTML = `<p class="mb-0">Ocurrió un error al iniciar/finalizar la revisión.</p>`;
        new bootstrap.Modal(document.getElementById('modalStatusRevision')).show();
        console.error(err);
      });
  });
});
</script>

{% endblock %}

