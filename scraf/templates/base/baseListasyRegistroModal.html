{% extends 'base/base.html' %}
{% load static %}
{% block librerias %}
   <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />  
{% endblock %}
{% block contenido %}   

  <div class="container-fluid mt-4">
    <!-- 1. Título y línea -->
    <div class="row mb-2">
      <div class="col">
        <h2 class="text-success fw-bold">Lista de Activos Fijos Designados</h2>
        <hr>
      </div>
    </div>

        <!-- 2. Botones de creacion de revisiones -->
        {% if not user.is_superuser %}
        <div class="row">
            <div class="col-md-12 d-flex justify-content-center">
                <button id="id_btn1"
                        type="button"
                        class="btn btn-success"
                        data-url="{{ entity_registro }}">
                {{ entity_registro_nom }}
                </button>
            </div>
        </div>
        {% endif %}


    <!-- 3. Modales -->
    <div id="modal1" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-3" id="modalContent1">

            </div>
        </div>
    </div>
    <div id="modal2" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-3" id="modalContent2">

            </div>
        </div>
    </div>
    {% block modalExtra %}
    
    {% endblock  %}

    <!-- 4. Tabla -->
    <div class="card card-default mt-3 mb-3">
        <div class="card-body p-0 mt-3" style="overflow-x: auto;">
            <table class="table table-striped table-bordered table-hover text-center text-wrap mb-0" id="myTable" style="min-width: 900px;">
                <thead class="bg-info">
                {% block thead %}
                {% endblock %}
                </thead>
                <tbody class="font-weight-bold">
                {% block tbody %}
                {% endblock %}
                </tbody>
            </table>
        </div>
    </div>

    <hr>
</div>
{% endblock %}

{% block script %}
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
{% endblock %}
{% block funcScript %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function cargarFormularioModal(url) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modalContent1').innerHTML = data.html_form;
                const modal = new bootstrap.Modal(document.getElementById('modal1'));
                modal.show();

                const form = document.querySelector('#modal1 form');
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                        body: formData,
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error("Respuesta HTML del servidor:", text);
                                throw new Error(`Error HTTP ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.form_is_valid) {
                            modal.hide();
                            location.reload();
                        } else {
                            document.getElementById('modalContent1').innerHTML = data.html_form;
                        }
                    })
                    .catch(error => {
                        console.error('Error en la solicitud:', error);
                        alert('Error al enviar el formulario');
                    });
                });
            });
    }

    function actualizarFormularioModal(url) {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error al cargar el formulario: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('modalContent2').innerHTML = data.html_form;
                const modal = new bootstrap.Modal(document.getElementById('modal2'));
                modal.show();
                setTimeout(() => {
                    const firstInput = document.querySelector('#modal2 input, #modal2 button');
                    if (firstInput) firstInput.focus();
                }, 300);
                const form = document.querySelector('#modal2 form');
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    fetch(url, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error al enviar el formulario: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.form_is_valid) {
                            modal.hide();
                            location.reload();
                        } else {
                            document.getElementById('modalContent2').innerHTML = data.html_form;
                        }
                    })
                    .catch(error => {
                        alert(error.message);
                        console.error(error);
                    });
                });
            })
            .catch(error => {
                alert(error.message);
                console.error(error);
            });
    }

      // Enlazar botón 1
  const btn1 = document.getElementById('id_btn1');
  if (btn1) {
    btn1.addEventListener('click', function (e) {
      e.preventDefault();
      const url = this.dataset.url;
      if (!url) {
        console.error('Falta data-url en #id_btn1');
        return;
      }
      cargarFormularioModal(url);
    });
  }

    // Abrir modal de VER (usa modal2 con contenido html)
  document.querySelectorAll('.btn-ver').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const url = this.dataset.url;
      fetch(url)
        .then(r => r.json())
        .then(data => {
          document.getElementById('modalContent2').innerHTML = data.html_form;
          new bootstrap.Modal(document.getElementById('modal2')).show();
        })
        .catch(err => {
          console.error(err);
          alert('No se pudo cargar la vista.');
        });
    });
  });

  // Abrir modal de EDITAR (usa la función genérica que ya tienes)
  document.querySelectorAll('.btn-editar').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const url = this.dataset.url;

      // Si tu base ya define actualizarFormularioModal, úsala
      if (typeof actualizarFormularioModal === 'function') {
        actualizarFormularioModal(url);
        return;
      }

      // Fallback por si no existe la función en la base:
      fetch(url)
        .then(r => r.json())
        .then(data => {
          const modalEl = document.getElementById('modal2');
          document.getElementById('modalContent2').innerHTML = data.html_form;
          const modal = new bootstrap.Modal(modalEl);
          modal.show();

          const form = modalEl.querySelector('form');
          form.addEventListener('submit', function (ev) {
            ev.preventDefault();
            const formData = new FormData(form);
            fetch(url, { method: 'POST', body: formData })
              .then(r => r.json())
              .then(resp => {
                if (resp.form_is_valid) {
                  modal.hide();
                  location.reload();
                } else {
                  document.getElementById('modalContent2').innerHTML = resp.html_form;
                }
              })
              .catch(err => {
                console.error(err);
                alert('No se pudo guardar.');
              });
          });
        })
        .catch(err => {
          console.error(err);
          alert('No se pudo cargar el formulario de edición.');
        });
    });
  });
</script>
{% endblock %}