{% extends 'base/baseListasyRegistroModal.html' %}
{% load static %}
{% block modalExtra %}
<!-- Modal -->
<div class="modal fade" id="modalAdvertenciaRevision" tabindex="-1" aria-labelledby="modalAdvertenciaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title text-dark" id="modalAdvertenciaLabel">Advertencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-dark">
        Ya hay una revisión activa en proceso. No puedes iniciar otra hasta que finalice la actual.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de resultado Inicio/Fin -->
<div class="modal fade" id="modalStatusRevision" tabindex="-1" aria-labelledby="modalStatusLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div id="statusHeader" class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalStatusLabel">Estado de la revisión</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="statusBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock  %}
{% block thead %}
    <tr>
        {% if user.is_encargado or user.is_superuser %}
        <th scope="col">LINE</th>
        {% endif %}
        <th scope="col">CODIGO</th>
        <th scope="col">DESCRIPCION DE LA REVISION</th>
        <th scope="col">ENCARGADO</th>
        <th scope="col">VER/EDITAR</th>
        <th scope="col">FECHA DE INICIO</th>
        <th scope="col">FECHA DE FINALIZACION</th>
        {% if user.is_encargado %}
        <th scope="col">ESTADO</th>
        <th scope="col">INICIO/FIN</th>
        {% endif %}
        <th scope="col">LISTA COMPLETA</th>
        <th id="th-form-rev" class="{% if not revisionr %}d-none{% endif %}">
        FORMULARIO DE REVISION
        </th>   
    </tr>

{% endblock %}
{% block tbody %}
    {% for revision in object_list %}
        <tr>
            {% if user.is_encargado or user.is_superuser %}
            <td><a href="{% url 'revision:lista_revisiones_line' revision.slug %}"><i class="fas fa-eye"></i></a></td>
            {% endif %}
            <td> {{ revision.slug }}</td>
            <td> {{ revision.nombre }} </td>
            <td> {{ revision.encargado.persona.nombrecompleto }}</td>
            <td>
                {% if revision.estado == None %}
                <button 
                    class="btn btn-primary btn-editar" 
                    data-url="{% url 'revision:ajax_a_Revision' revision.slug %}">
                    <i class="fas fa-edit"></i>
                </button>
                {% else %}
                <button
                    class="btn btn-primary btn-ver" 
                    data-url="{% url 'revision:ajax_ver_Revision' revision.slug %}">
                    <i class="fas fa-eye"></i>
                </button>
                {% endif %}
            </td>
            <td id="fecha-inicio-{{ revision.slug }}"> {{ revision.fechaHora_inicio }}</td>
            <td id="fecha-fin-{{ revision.slug }}"> {{ revision.fechaHora_finalizacion }}</td>            
            <td id="estado-{{ revision.slug }}"> {% if revision.estado == None %} Sin Accion
            {% elif revision.estado %} En Curso {% else %} Finalizado
            {% endif %}</td>
            <td>
                {% if revisionr and revision_datos.slug != revision.slug %}
                    <button type="button"
                            class="btn btn-primary-subtle btn-xs iniciar-finalizar-true"
                            data-revisionr="true">
                        {% if revision.estado == None %}<i class="fas fa-circle text-danger"></i>
                        {% elif revision.estado %}<i class="fas fa-play-circle text-primary"></i>
                        {% else %}<i class="fas fa-check-circle text-success"></i>{% endif %}
                    </button>
                    {% else %}
                    <button type="button"
                            class="btn btn-primary-subtle btn-xs iniciar-finalizar-revision"
                            data-url="{% url 'revision:inicio_fin_revision' revision.slug %}"
                            data-slug="{{ revision.slug }}">
                        {% if revision.estado == None %}<i class="fas fa-circle text-danger"></i>
                        {% elif revision.estado %}<i class="fas fa-play-circle text-primary"></i>
                        {% else %}<i class="fas fa-check-circle text-success"></i>{% endif %}
                    </button>
                {% endif %}
            </td>
            <td>
                <a href="" type="button"
                   class="btn btn-primary btn-xs">
                   <i class="fas fa-edit"></i> 
                </a>
            </td>
            <td class="td-form-rev {% if not revisionr %}d-none{% endif %}" data-slug="{{ revision.slug }}">
            {% if revisionr and revision.slug == revision_datos.slug %}
                <button
                type="button"
                class="btn btn-primary btn-xs btn-form-revision-activo"
                data-url="{% url 'revision:revision_activo' revision.slug %}?ajax=1">
                <i class="fas fa-edit"></i>
                </button>
            {% else %}
                <span>-</span>
            {% endif %}
            </td>          
        </tr>
    {% endfor %}
{% endblock %}

{% block scripfun %}
<script>
function abrirModal() {
    const modalContent = $('#modalContent2'); 
    
    let codigo = modalContent.find('#campo').val();
    let slug = modalContent.find('#revision-slug-data').val();
    let csrfToken = modalContent.find('input[name="csrfmiddlewaretoken"]').val(); 

    if (!codigo) {
        alert('Por favor, ingresa el código del activo.');
        return;
    }

    if (!slug || !csrfToken) {
        alert('Error: Datos de revisión (SLUG/CSRF) no encontrados.');
        console.error("Fallo de datos:", { slug: slug, csrfToken: csrfToken });
        return;
    }

    const url = `/revision/buscar_activo/${slug}/`;
    
    $.ajax({
        url: url, 
        method: "POST",
        data: {
            'codigo': codigo,
            'csrfmiddlewaretoken': csrfToken
        },
        success: function(data) {
            // Carga el HTML en el modal anidado '#modalActivo'
            $('#modalContent').html(data); 
            $('#modalActivo').modal('show');
            $('#campo').val(''); // Limpia el campo
        },
        error: function(xhr, status, error) {
            if (xhr.status === 404) {
                alert('404: Activo no encontrado o código incorrecto.');
            } else if (xhr.status === 403) {
                 alert('403: Error de seguridad CSRF. Revise el token.');
            } else if (xhr.status === 500) {
                 alert('500: Error interno del servidor. Revise la consola del servidor (F12) o los logs.');
            } else {
                alert(`Error ${xhr.status} en la petición. Revise F12 para más detalles.`);
                console.error("AJAX Error:", xhr.responseText, status, error);
            }
        }
    });
}
// ----------------------------------------------------------------

$(document).ready(function() {
    // Inicialización de jQuery
    $('#btn-enviar-activo').on('click', abrirModal); 
});

document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('myTable') || document;

    // ----------------------------------------------------
    // 1. REGISTRAR NUEVA REVISION (Botón #id_btn1) - (Restaurado)
    // ----------------------------------------------------
    document.addEventListener('click', function(e){
        const btn = e.target.closest('#id_btn1');
        if (!btn) return;
        e.preventDefault();
        const url = btn.dataset.url || "{{ entity_registro|default:'' }}";
        if (!url) return console.error('Falta data-url en #id_btn1');
        if (typeof cargarFormularioModal === 'function') {
            cargarFormularioModal(url);
        }
    });

    // ----------------------------------------------------
    // 2. VER y EDITAR (Botones de la tabla) - (Restaurado)
    // ----------------------------------------------------
    // VER (usa modal2)
    document.addEventListener('click', function(e){
        const btn = e.target.closest('.btn-ver');
        if (!btn) return;
        e.preventDefault();
        const url = btn.getAttribute('data-url');
        fetch(url)
            .then(r => r.json())
            .then(data => {
                document.getElementById('modalContent2').innerHTML = data.html_form;
                new bootstrap.Modal(document.getElementById('modal2')).show();
            })
            .catch(err => console.error(err));
    });

    // EDITAR (usa modal2 con POST)
    document.addEventListener('click', function(e){
        const btn = e.target.closest('.btn-editar');
        if (!btn) return;
        e.preventDefault();
        const url = btn.dataset.url;
        if (typeof actualizarFormularioModal === 'function') {
            actualizarFormularioModal(url);
        } else {
            // Fallback (restaurado)
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const modalEl = document.getElementById('modal2');
                    document.getElementById('modalContent2').innerHTML = data.html_form;
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    const form = modalEl.querySelector('form');
                    form.addEventListener('submit', function (ev) {
                        ev.preventDefault();
                        const formData = new FormData(form);
                        fetch(url, { method: 'POST', body: formData })
                            .then(r => r.json())
                            .then(resp => {
                                if (resp.form_is_valid) { modal.hide(); location.reload(); }
                                else { document.getElementById('modalContent2').innerHTML = resp.html_form; }
                            })
                            .catch(err => console.error(err));
                    });
                })
                .catch(err => console.error(err));
        }
    });
    
    // ADVERTENCIA si hay otra revisión activa (Restaurado)
    document.addEventListener('click', function(e){
        const btn = e.target.closest('.iniciar-finalizar-true');
        if (!btn) return;
        e.preventDefault();
        new bootstrap.Modal(document.getElementById('modalAdvertenciaRevision')).show();
    });
    
    // ----------------------------------------------------
    // 3. INICIO/FIN REVISION (Mantenido)
    // ----------------------------------------------------
    table.addEventListener('click', function (e) {
        const btn = e.target.closest('.iniciar-finalizar-revision');
        if (!btn) return;

        // ... (Toda la lógica AJAX de inicio/fin revisión se mantiene igual)
        e.preventDefault();
        const url  = btn.getAttribute('data-url');
        const slug = btn.getAttribute('data-slug');
        
        fetch(url)
            .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(t); }))
            .then(data3 => {
                // ... (Lógica de pintado de modal de estado) ...
                let titulo = 'Estado de la revisión';
                let headerClass = 'bg-primary text-white';
                let contenido = '';

                if (data3.status === 'iniciada') {
                    titulo = 'Revisión iniciada';
                    headerClass = 'bg-success text-white';
                    contenido = `
                        <p class="mb-1"><strong>Estado:</strong> En Curso</p>
                        ${data3.fechaHora_inicio ? `<p class="mb-0"><strong>Fecha/Hora de inicio:</strong> ${data3.fechaHora_inicio}</p>` : ''}
                    `;
                } else if (data3.status === 'finalizada') {
                    titulo = 'Revisión finalizada';
                    headerClass = 'bg-success text-white';
                    contenido = `
                        <p class="mb-1"><strong>Estado:</strong> Finalizado</p>
                        ${data3.fechaHora_finalizacion ? `<p class="mb-0"><strong>Fecha/Hora de finalización:</strong> ${data3.fechaHora_finalizacion}</p>` : ''}
                    `;
                } else if (data3.status === 'ya_finalizada') {
                    titulo = 'Revisión ya finalizada';
                    headerClass = 'bg-info text-white';
                    contenido = `<p class="mb-0">Esta revisión ya estaba finalizada.</p>`;
                } else {
                    headerClass = 'bg-secondary text-white';
                    contenido = `<p class="mb-0">Estado: ${data3.status ?? 'Desconocido'}</p>`;
                }

                const header = document.getElementById('statusHeader');
                header.className = 'modal-header ' + headerClass;
                document.getElementById('modalStatusLabel').textContent = titulo;
                document.getElementById('statusBody').innerHTML = contenido;
                new bootstrap.Modal(document.getElementById('modalStatusRevision')).show();
                
                // --- B. Actualizar la fila de la tabla (Estado, Fechas, Icono) ---
                const estadoCell = document.getElementById(`estado-${slug}`);
                const inicioCell = document.getElementById(`fecha-inicio-${slug}`);
                const finCell    = document.getElementById(`fecha-fin-${slug}`);
                const th = document.getElementById('th-form-rev');
                const tds = document.querySelectorAll('.td-form-rev');


                if (data3.status === 'iniciada') {
                    // 1. Actualiza el icono a PLAY AZUL
                    const icon = btn.querySelector('i'); 
                    if (icon) icon.className = 'fas fa-play-circle text-primary';
                    
                    // 2. Actualiza celdas
                    if (estadoCell) estadoCell.textContent = 'En Curso';
                    if (inicioCell && data3.fechaHora_inicio) inicioCell.textContent = data3.fechaHora_inicio;
                    
                    // 3. Muestra la columna FORMULARIO DE REVISION
                    th && th.classList.remove('d-none');
                    tds.forEach(td => td.classList.remove('d-none'));

                    // 4. Pone el botón SOLO en la fila activa
                    tds.forEach(td => {
                        const rowSlug = td.getAttribute('data-slug');
                        if (rowSlug === slug) {
                            // Se asume la URL del botón del formulario de revisión
                            td.innerHTML = `
                                <button type="button"
                                        class="btn btn-primary btn-xs btn-form-revision-activo"
                                        data-url="/revision/RevisionActivo/${slug}/">
                                    <i class="fas fa-edit"></i>
                                </button>`;
                        } else {
                            td.innerHTML = `<span>-</span>`;
                        }
                    });
                }

                if (data3.status === 'finalizada') {
                    // 1. Actualiza el icono a CHECK VERDE
                    const icon = btn.querySelector('i'); 
                    if (icon) icon.className = 'fas fa-check-circle text-success';
                    
                    // 2. Actualiza celdas
                    if (estadoCell) estadoCell.textContent = 'Finalizado';
                    if (finCell && data3.fechaHora_finalizacion) finCell.textContent = data3.fechaHora_finalizacion;
                    
                    // 3. Oculta la columna FORMULARIO DE REVISION
                    th && th.classList.add('d-none');
                    tds.forEach(td => {
                        td.classList.add('d-none');
                        td.innerHTML = `<span>-</span>`; 
                    });
                }
                
                if (data3.status === 'ya_finalizada') {
                    th && th.classList.add('d-none');
                    tds.forEach(td => td.classList.add('d-none'));
                }
                
                // Recarga la página después de iniciar/finalizar una revisión para que los iconos de
                // 'VER/EDITAR' se actualicen correctamente
                location.reload(); 
            })
            .catch(err => {
                const header = document.getElementById('statusHeader');
                header.className = 'modal-header bg-danger text-white';
                document.getElementById('modalStatusLabel').textContent = 'Error';
                document.getElementById('statusBody').innerHTML = `<p class="mb-0">Ocurrió un error al iniciar/finalizar la revisión.</p>`;
                new bootstrap.Modal(document.getElementById('modalStatusRevision')).show();
                console.error(err);
            });
    });

    // ----------------------------------------------------
    // 4. ABRIR FORMULARIO DE REVISION EN EL CUERPO PRINCIPAL (CORREGIDO)
    // ----------------------------------------------------
    table.addEventListener('click', function (e) {
        const b = e.target.closest('.btn-form-revision-activo');
        if (!b) return;

        e.preventDefault();
        // Usamos la URL de la data-url, pero nos aseguramos de no enviar el parámetro AJAX.
        // Asumimos que la vista de Django usará esta URL para renderizar la página completa.
        const url = b.dataset.url.replace('?ajax=1', ''); 

        // REDIRECCIÓN COMPLETA
        window.location.href = url;
    });

}); // <--- Cierre del DOMContentLoaded
</script>
{% endblock scripfun %}