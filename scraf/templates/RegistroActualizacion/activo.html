{% extends 'base/form2col.html' %}
{% load static %}
{% block alert %}
    {% for field in form %}
        <div class="row align-items-center  bg-warning text-white">                
          {% if field.help_text %}<div class="form-text text-warning text-muted small">{{ field.help_text }}</div>{% endif %}
          {% if field.errors %}<div class="text-danger small mt-1">{% for error in field.errors %}<span>({{ error }})</span>{% endfor %}</div>{% endif %}
        </div>        
    {% endfor %}
  </div>    
  {% endblock alert %}
  {% block formulario %}      
  <div class="row">
    <div class="col-sm-12 col-md-6">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">CÃ³digo del Activo *</label>
          {{ form.codigo }}
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Estado del Activo</label>
          {{ form.estadoActivo }}
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label fw-bold">Grupo Contable *</label>
            {{ form.grupoContable }}
            <div class="form-text">Seleccione un grupo contable</div>
        </div>
        <div class="col-md-6">
            <label class="form-label fw-bold">Auxiliar Contable *</label>
            {{ form.auxiliar }}  <!-- CAMBIAR ESTO -->
            <div class="form-text" id="auxiliarHelp">Se habilitarÃ¡ al seleccionar un grupo</div>
        </div>
    </div>
    </div>
    <div class="col-sm-12 col-md-6">
      <div class="mb-3">
        <label class="form-label  fw-bold">DescripciÃ³n *</label>
        {{ form.descActivo }}
      </div>
    </div>
  </div>
{% endblock formulario %}

{% block formulario2 %}
  {% if form2 %}
    <h4 class="text-center">{{subtitulo_2}}</h4>
    <hr>

    {% for field in form2 %}
      <div class="mb-3 row">
        <label class="col-sm-4 col-form-label text-end">{{ field.label_tag }}</label>
        <div class="col-sm-8">
          {{ field }}
          {% if field.help_text %}<div class="form-text text-warning text-muted small">{{ field.help_text }}</div>{% endif %}
          {% if field.errors %}<div class="text-danger small mt-1">{% for error in field.errors %}<span>({{ error }})</span>{% endfor %}</div>{% endif %}
        </div>
      </div>
    {% endfor %}

    {% if form.estado %}
      <div class="mb-3 row">
        <label class="col-sm-4 col-form-label text-end">{{ form.estado.label_tag }}</label>
        <div class="col-sm-8">
          {{ form.estado }}
          {% if form.estado.help_text %}<div class="form-text text-warning text-muted small">{{ form.estado.help_text }}</div>{% endif %}
          {% if form.estado.errors %}<div class="text-danger small mt-1">{% for error in form.estado.errors %}<span>({{ error }})</span>{% endfor %}</div>{% endif %}
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endblock formulario2 %}

 {% block script %}

<script>
$(document).ready(function() {
    const grupoSelect = $('#id_grupoContable');
    const auxiliarSelect = $('#id_auxiliar');
    const auxiliarHelp = $('#auxiliarHelp');
    
    let grupoSeleccionado = null;
    
    const urlGetAuxiliares = '{% url "activos:Auxiliares_por_grupo" %}';
    
    function inicializarGrupoSelect2() {
        grupoSelect.select2({
            placeholder: 'Seleccione grupo contable...',
            allowClear: true,
            language: 'es'
        });
    }
    
    function inicializarAuxiliarSelect2() {
        auxiliarSelect.select2({
            ajax: {
                url: urlGetAuxiliares,
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        grupo_id: grupoSeleccionado,
                        page: params.page || 1
                    };
                },
                processResults: function(data, params) {
                    console.log('ðŸ“¦ Datos recibidos para auxiliar:', data);
                    return {
                        results: data,
                        pagination: { more: false }
                    };
                },
                error: function(xhr, status, error) {
                    console.error('Error en AJAX:', error);
                    return { results: [] };
                }
            },
            minimumInputLength: 0,
            placeholder: 'Seleccione auxiliar contable...',
            allowClear: true,
            disabled: true,
            language: 'es'
        });
    }
    
    function manejarCambioGrupo() {
        grupoSelect.on('change', function() {
            grupoSeleccionado = $(this).val();
            //console.log(' Grupo seleccionado:', grupoSeleccionado);
            
            if (grupoSeleccionado) {
                auxiliarSelect.prop('disabled', false);
                auxiliarSelect.val(null).trigger('change');
                auxiliarSelect.select2('enable');
                auxiliarHelp.text('Seleccione un auxiliar contable');
            } else {
                auxiliarSelect.prop('disabled', true);
                auxiliarSelect.val(null).trigger('change');
                auxiliarSelect.select2('enable', false);
                auxiliarHelp.text('Primero seleccione un grupo contable');
            }
        });
    }
    
    function inicializarSelect2() {
        inicializarGrupoSelect2();
        inicializarAuxiliarSelect2();
        manejarCambioGrupo();
        
        const grupoInicial = grupoSelect.val();
        if (grupoInicial) {
            grupoSeleccionado = grupoInicial;
            auxiliarSelect.prop('disabled', false);
            auxiliarSelect.select2('enable');
        }
    }
    
    inicializarSelect2();
});
</script>
 {% endblock %}
